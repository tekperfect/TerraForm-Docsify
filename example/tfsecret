#!/bin/bash


# Default Vars
filePath="~/secrets/terraform.tfvars.asc"


function usage()
{
    echo "usage: tfsecret [-fp | --file-path path_to_file]"
    exit 0
}

function decrypt()
{
    # Check if required commands exist and file
    if ! test -f "${filePath}"; then
        echo "${filePath} dosen't exist or path is wrong"
        exit 1
    fi

    if ! [ ${filePath: -4} == ".asc" ]; then
        echo "${filePath} file isn't encrypted or does not have .asc gpg"
        exit 1
    fi

    if ! type "gpg" > /dev/null; then 
        echo "gpg doesn't exist, please install it into path"    
        exit 1
    fi

    cp $filePath ./terraform.tfvars.asc
    gpg --decrypt --no-symkey-cache --output ./terraform.tfvars ./terraform.tfvars.asc


    # Start Terraform
    terraform plan -var-file=terraform.tfvars
    terraform apply -var-file=terraform.tfvars


    # Remove Terraform.tfvars
    echo "Terraform: Done"
    echo "Deleting tfvars* in 5s"
    sleep 5s
    rm ./terraform.tfvars*
    exit 0
}


# main flag
while [ "$1" != "" ]; do
    case $1 in
        -fp | --file-path )     shift
                                filePath="$1"                                    
                                ;;
        help )                  shift
                                usage
                                ;;
    esac
    shift
done

decrypt
 